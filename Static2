async function loadInventory() {
  
  const userRole = document.getElementById('user-role').dataset.role;

  const response = await fetch("/get_inventory");
  const data = await response.json();

  const tableBody = document.querySelector("#inventoryTable tbody");
  tableBody.innerHTML = "";

  const lowStockItems = [];

  if (data.inventory) {
    // PUTHUSA: '(item, index)' nu add pannirukkom
    data.inventory.forEach((item, index) => {
      const row = document.createElement("tr");

      // PUTHU LOGIC: 0 kku red, 1-10 kku yellow
      if (item.actual_quantity === 0) {
        row.classList.add("zero-stock"); // Red color
        lowStockItems.push(item);
      } else if (item.actual_quantity <= 10) {
        row.classList.add("low-stock-warning"); // Yellow color
        lowStockItems.push(item);
      }
      // --- PUTHU LOGIC MUDINJADHU ---

      let editButtonHtml = '';
      let deleteButtonHtml = '';
      if (userRole === 'boss') {
        editButtonHtml = `
          <td class="boss-action">
            <a href="/edit_item/${item.id}" class="edit-btn">Edit</a>
          </td>
        `;
        deleteButtonHtml = `
          <td class="boss-action">
            <form action="/delete_item/${item.id}" method="POST" style="margin:0;">
              <button type="submit" class="delete-btn">Delete</button>
            </form>
          </td>
        `;
      }

      row.innerHTML = `
        <td>${index + 1}</td> <td>${item.product_id}</td>
        <td>${item.product_name}</td>
        <td>${item.expected_quantity}</td>
        <td>${item.actual_quantity}</td>
        ${editButtonHtml} 
        ${deleteButtonHtml} 
      `;
      
      tableBody.appendChild(row);
    });
  } 

  const notificationArea = document.getElementById("low-stock-notification-area");
  
  if (data.shrinkage && data.shrinkage.length > 0) {
    let message = `<h3>⚠️ Shrinkage Detected!</h3><p>The following items are missing quantities:</p><ul>`;
    data.shrinkage.forEach(item => {
      message += `<li><b>${item.product_name}</b> (ID: ${item.product_id}) - Missing: <b>${item.missing}</b> units</li>`;
    });
    message += `</ul>`;
    notificationArea.innerHTML = message;
    notificationArea.className = "flash-message error"; 
  } else {
    if (lowStockItems.length > 0) {
        let message = `<h3>⚠️ Low Stock Alert!</h3><p>The following items are running low:</p><ul>`;
        lowStockItems.forEach(item => {
          message += `<li><b>${item.product_name}</b> (ID: ${item.product_id}) - Only <b>${item.actual_quantity}</b> left!</li>`;
        });
        message += `</ul>`;
        notificationArea.innerHTML = message;
        notificationArea.className = "flash-message error";
    } else {
        notificationArea.innerHTML = "";
        notificationArea.className = "";
    }
  }
} 

document.getElementById("refreshBtn").addEventListener("click", loadInventory);
window.onload = loadInventory;

// --- Search Bar Logic (Ithu appadiye irukkattum) ---
const searchInput = document.getElementById('inventorySearch');
if (searchInput) {
  searchInput.addEventListener('keyup', function() {
    const filterText = searchInput.value.toLowerCase();
    const table = document.getElementById('inventoryTable');
    const tableBody = table.getElementsByTagName('tbody')[0];
    const allRows = tableBody.getElementsByTagName('tr');
    for (let i = 0; i < allRows.length; i++) {
      const row = allRows[i];
      const cells = row.getElementsByTagName('td');
      const productId = cells[1] ? cells[1].textContent.toLowerCase() : '';
      const productName = cells[2] ? cells[2].textContent.toLowerCase() : '';
      if (productId.includes(filterText) || productName.includes(filterText)) {
        row.style.display = ""; 
      } else {
        row.style.display = "none";
      }
    }
  });
}
